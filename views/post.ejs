<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸŒ¸ æ«»å‚46 ãƒ–ãƒ­ã‚°ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</h1>
        <nav>
          <a href="/">ãƒ›ãƒ¼ãƒ </a>
          <a href="/member/<%= post.member_id %>"
            >â† <%= post.member_name %>ã®è¨˜äº‹ä¸€è¦§</a
          >
          <a href="/search">æ¤œç´¢</a>
        </nav>
      </header>

      <main>
        <!-- ãƒ–ãƒ­ã‚°ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸Šéƒ¨ï¼‰ -->
        <div class="blog-navigation">
          <% if (prevPost) { %>
          <a href="/post/<%= prevPost.id %>" class="nav-button prev-post">
            <span class="nav-arrow">â†</span>
            <span class="nav-text">
              <span class="nav-label">å‰ã®ãƒ–ãƒ­ã‚°</span>
              <span class="nav-title"><%= prevPost.title || 'ç„¡é¡Œ' %></span>
              <span class="nav-date"><%= prevPost.date %></span>
            </span>
          </a>
          <% } else { %>
          <div class="nav-button nav-disabled">
            <span class="nav-arrow">â†</span>
            <span class="nav-text">
              <span class="nav-label">ã“ã‚ŒãŒæœ€æ–°ã§ã™</span>
            </span>
          </div>
          <% } %> <% if (nextPost) { %>
          <a href="/post/<%= nextPost.id %>" class="nav-button next-post">
            <span class="nav-text">
              <span class="nav-label">æ¬¡ã®ãƒ–ãƒ­ã‚°</span>
              <span class="nav-title"><%= nextPost.title || 'ç„¡é¡Œ' %></span>
              <span class="nav-date"><%= nextPost.date %></span>
            </span>
            <span class="nav-arrow">â†’</span>
          </a>
          <% } else { %>
          <div class="nav-button nav-disabled">
            <span class="nav-text">
              <span class="nav-label">ã“ã‚ŒãŒæœ€å¤ã§ã™</span>
            </span>
            <span class="nav-arrow">â†’</span>
          </div>
          <% } %>
        </div>

        <article class="blog-post">
          <div class="post-header">
            <h1><%= post.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—' %></h1>
            <div class="post-meta">
              <span class="author">âœï¸ <%= post.member_name %></span>
              <span class="date">ğŸ“… <%= post.date %></span>
              <a
                href="<%= post.url %>"
                target="_blank"
                class="original-link-header"
              >
                ğŸ”— å…¬å¼ã‚µã‚¤ãƒˆã§è¦‹ã‚‹
              </a>
            </div>
          </div>

          <div class="post-content">
            <% if (post.content && post.content.includes('<')) { %>
            <!-- HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç”»åƒãƒ‘ã‚¹ã‚’ç’°å¢ƒã«å¿œã˜ãŸURLã«å¤‰æ›ã—ã¦è¡¨ç¤º -->
            <%
              let content = post.content || '';

              // Step 1: ç”»åƒURLã¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ
              const urlToLocalMap = new Map();
              if (post.images && post.local_images) {
                for (let i = 0; i < post.images.length; i++) {
                  const imageUrl = post.images[i];
                  const localPath = post.local_images[i];
                  if (imageUrl && localPath && localPath.length > 0) {
                    urlToLocalMap.set(imageUrl, toImageUrl(localPath));
                  }
                }
              }

              // Step 2: data-srcå±æ€§ã‚’srcå±æ€§ã«å¤‰æ›ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒURLã«ç½®æ›
              // data-src ã‚’æŒã¤ img ã‚¿ã‚°ã‚’å‡¦ç†ï¼ˆlazy loadingå¯¾å¿œï¼‰
              content = content.replace(/<img\b([^>]*)\bdata-src="([^"]+)"([^>]*)>/gi, function(match, before, dataSrc, after) {
                // data-srcã®URLã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã«å¤‰æ›
                const localUrl = urlToLocalMap.get(dataSrc) || dataSrc;
                // srcãŒã™ã§ã«ã‚ã‚‹ã‹ç¢ºèª
                const hasSrc = /\bsrc=/.test(before + after);
                if (hasSrc) {
                  // srcãŒã‚ã‚‹å ´åˆã¯data-srcã®ã¿ç½®æ›
                  return '<img' + before + 'data-src="' + localUrl + '"' + after + '>';
                } else {
                  // srcãŒãªã„å ´åˆã¯data-srcã‚’srcã«å¤‰æ›
                  return '<img' + before + 'src="' + localUrl + '"' + after + '>';
                }
              });

              // Step 3: é€šå¸¸ã®srcå±æ€§ã®ç”»åƒURLã‚’ç½®æ›
              content = content.replace(/<img\b([^>]*)\bsrc="([^"]+)"([^>]*)>/gi, function(match, before, src, after) {
                // ã™ã§ã«ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ã‚¹ã«å¤‰æ›æ¸ˆã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                if (src.startsWith('/images/') || src.startsWith('images/')) {
                  return match;
                }
                // ãƒãƒƒãƒ”ãƒ³ã‚°ã‹ã‚‰æ¤œç´¢
                const localUrl = urlToLocalMap.get(src);
                if (localUrl) {
                  return '<img' + before + 'src="' + localUrl + '"' + after + '>';
                }
                return match;
              });

              // Step 4: æ®‹ã‚Šã®ç›¸å¯¾ãƒ‘ã‚¹ã‚’å…¬å¼ã‚µã‚¤ãƒˆã®URLã«å¤‰æ›
              content = content.replace(/src="\/([^"]+)"/g, function(match, path) {
                // images/ ã§å§‹ã¾ã‚‹ç›¸å¯¾ãƒ‘ã‚¹ã¯ toImageUrl ã§å…¬é–‹URLã¸
                if (path.startsWith('images/')) return 'src="' + toImageUrl(path) + '"';
                // httpã§å§‹ã¾ã‚‹URLã¯ãã®ã¾ã¾
                if (path.startsWith('http')) return match;
                // ãã‚Œä»¥å¤–ã¯å…¬å¼ã‚µã‚¤ãƒˆã®URLã«å¤‰æ›
                return 'src="https://sakurazaka46.com/' + path + '"';
              });

              // Step 5: srcset / data-srcset ã®ç½®æ›ï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ç”»åƒå¯¾å¿œï¼‰
              content = content.replace(/\b(data-srcset|srcset)="([^"]+)"/g, function(match, attr, value) {
                // value ä¾‹: "url1 1x, url2 2x" ã¾ãŸã¯ "url1 320w, url2 640w"
                var parts = value.split(',');
                var rebuilt = [];
                for (var i = 0; i < parts.length; i++) {
                  var part = parts[i].trim();
                  if (!part) continue;
                  var spaceIdx = part.lastIndexOf(' ');
                  var urlOnly = spaceIdx > 0 ? part.substring(0, spaceIdx) : part;
                  var descriptor = spaceIdx > 0 ? part.substring(spaceIdx + 1) : '';
                  // ãƒãƒƒãƒ”ãƒ³ã‚°ã‹ã‚‰æ¤œç´¢
                  var localUrl = urlToLocalMap.get(urlOnly) || urlOnly;
                  rebuilt.push(descriptor ? (localUrl + ' ' + descriptor) : localUrl);
                }
                return attr + '="' + rebuilt.join(', ') + '"';
              });
            %>
            <%- content %>
            <% } else { %>
            <!-- ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ”¹è¡Œå¯¾å¿œã§è¡¨ç¤º -->
            <%- (post.content || '').replace(/\n/g, '<br />') %>
            <% } %>
          </div>

          <div class="post-footer">
            <div class="saved-date">ä¿å­˜æ—¥æ™‚: <%= post.created_at %></div>
          </div>
        </article>

        <!-- ãƒ–ãƒ­ã‚°ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¸‹éƒ¨ï¼‰ -->
        <div class="blog-navigation">
          <% if (prevPost) { %>
          <a href="/post/<%= prevPost.id %>" class="nav-button prev-post">
            <span class="nav-arrow">â†</span>
            <span class="nav-text">
              <span class="nav-label">å‰ã®ãƒ–ãƒ­ã‚°</span>
              <span class="nav-title"><%= prevPost.title || 'ç„¡é¡Œ' %></span>
              <span class="nav-date"><%= prevPost.date %></span>
            </span>
          </a>
          <% } else { %>
          <div class="nav-button nav-disabled">
            <span class="nav-arrow">â†</span>
            <span class="nav-text">
              <span class="nav-label">ã“ã‚ŒãŒæœ€æ–°ã§ã™</span>
            </span>
          </div>
          <% } %> <% if (nextPost) { %>
          <a href="/post/<%= nextPost.id %>" class="nav-button next-post">
            <span class="nav-text">
              <span class="nav-label">æ¬¡ã®ãƒ–ãƒ­ã‚°</span>
              <span class="nav-title"><%= nextPost.title || 'ç„¡é¡Œ' %></span>
              <span class="nav-date"><%= nextPost.date %></span>
            </span>
            <span class="nav-arrow">â†’</span>
          </a>
          <% } else { %>
          <div class="nav-button nav-disabled">
            <span class="nav-text">
              <span class="nav-label">ã“ã‚ŒãŒæœ€å¤ã§ã™</span>
            </span>
            <span class="nav-arrow">â†’</span>
          </div>
          <% } %>
        </div>
      </main>

      <footer>
        <p>&copy; 2025 æ«»å‚46 ãƒ–ãƒ­ã‚°ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</p>
      </footer>
    </div>

    <!-- ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <button
      id="scroll-to-top"
      onclick="scrollToTop()"
      title="ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹"
    >
      â†‘
    </button>

    <script>
      // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      function scrollToTop() {
        window.scrollTo({
          top: 0,
          behavior: "smooth",
        });
      }

      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
      function toggleScrollButton() {
        const scrollButton = document.getElementById("scroll-to-top");
        if (window.pageYOffset > 300) {
          scrollButton.classList.add("show");
        } else {
          scrollButton.classList.remove("show");
        }
      }

      // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®è¨­å®š
      document.addEventListener("DOMContentLoaded", function () {
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
        window.addEventListener("scroll", toggleScrollButton);

        // åˆæœŸè¡¨ç¤ºæ™‚ã‚‚ãƒã‚§ãƒƒã‚¯
        toggleScrollButton();
      });
    </script>
  </body>
</html>
