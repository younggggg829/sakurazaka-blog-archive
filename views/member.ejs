<%
  function getQueryString(overrides) {
    const params = new URLSearchParams();
    if (typeof req !== 'undefined' && req.query && req.query.per_page) {
      params.set('per_page', req.query.per_page);
    }
    Object.keys(overrides).forEach(key => {
      params.set(key, overrides[key]);
    });
    return params.toString();
  }
%>
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>üå∏ <%= member.name %>„ÅÆ„Éñ„É≠„Ç∞</h1>
      <nav>
        <a href="/">„Éõ„Éº„É†</a>
        <a href="/search">Ê§úÁ¥¢</a>
      </nav>
    </header>

    <main>
      <div class="blog-list">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>„Éñ„É≠„Ç∞Ë®ò‰∫ã‰∏ÄË¶ß (<%= (typeof pagination !== 'undefined' && pagination) ? pagination.totalPosts : posts.length %>‰ª∂)</h2>
          <div class="per-page-selector">
            <label>Ë°®Á§∫‰ª∂Êï∞:</label>
            <select id="per-page-select" onchange="changePerPage(this.value)">
              <option value="20" <%= (typeof pagination !== 'undefined' && pagination && pagination.perPage == 20) ? 'selected' : '' %>>20‰ª∂</option>
              <option value="50" <%= (typeof pagination !== 'undefined' && pagination && pagination.perPage == 50) ? 'selected' : ((typeof req === 'undefined' || !req.query || !req.query.per_page) ? 'selected' : '') %>>50‰ª∂</option>
              <option value="100" <%= (typeof pagination !== 'undefined' && pagination && pagination.perPage == 100) ? 'selected' : '' %>>100‰ª∂</option>
            </select>
          </div>
        </div>

        <% if (posts.length === 0) { %>
          <p>„Åæ„Å†„Éñ„É≠„Ç∞Ë®ò‰∫ã„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
        <% } else { %>
          <!-- „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Ôºà‰∏äÈÉ®Ôºâ -->
          <% if (typeof pagination !== 'undefined' && pagination && pagination.totalPages > 1) { %>
            <div class="pagination-container">
              <div class="pagination">
                <% if (pagination.hasPrev) { %>
                  <a href="?<%= getQueryString({page: pagination.page - 1}) %>" class="page-link">‚Üê Ââç„Å∏</a>
                <% } %>

                <%
                  const maxVisible = 5;
                  let startPage = Math.max(1, pagination.page - Math.floor(maxVisible / 2));
                  let endPage = Math.min(pagination.totalPages, startPage + maxVisible - 1);
                  if (endPage - startPage < maxVisible - 1) {
                    startPage = Math.max(1, endPage - maxVisible + 1);
                  }
                %>

                <% if (startPage > 1) { %>
                  <a href="?<%= getQueryString({page: 1}) %>" class="page-link">1</a>
                  <% if (startPage > 2) { %>
                    <span class="page-dots">...</span>
                  <% } %>
                <% } %>

                <% for (let i = startPage; i <= endPage; i++) { %>
                  <% if (i === pagination.page) { %>
                    <span class="page-current"><%= i %></span>
                  <% } else { %>
                    <a href="?<%= getQueryString({page: i}) %>" class="page-link"><%= i %></a>
                  <% } %>
                <% } %>

                <% if (endPage < pagination.totalPages) { %>
                  <% if (endPage < pagination.totalPages - 1) { %>
                    <span class="page-dots">...</span>
                  <% } %>
                  <a href="?<%= getQueryString({page: pagination.totalPages}) %>" class="page-link"><%= pagination.totalPages %></a>
                <% } %>

                <% if (pagination.hasNext) { %>
                  <a href="?<%= getQueryString({page: pagination.page + 1}) %>" class="page-link">Ê¨°„Å∏ ‚Üí</a>
                <% } %>
              </div>
              <div class="page-info">
                <%= ((pagination.page - 1) * pagination.perPage + 1) %> - <%= Math.min(pagination.page * pagination.perPage, pagination.totalPosts) %> / <%= pagination.totalPosts %>‰ª∂
              </div>
            </div>
          <% } %>

          <% posts.forEach(post => { %>
            <article class="blog-item">
              <a href="/post/<%= post.id %>">
                <div class="blog-header">
                  <h3><%= post.title || '„Çø„Ç§„Éà„É´„Å™„Åó' %></h3>
                  <span class="date"><%= post.date %></span>
                </div>
                <div class="blog-preview">
                  <%= cleanTextPreview(post.content, 150) %>
                </div>
                <div class="blog-meta">
                  <span class="read-more">Á∂ö„Åç„ÇíË™≠„ÇÄ ‚Üí</span>
                </div>
              </a>
            </article>
          <% }) %>

          <!-- „Éö„Éº„Ç∏„Éç„Éº„Ç∑„Éß„É≥Ôºà‰∏ãÈÉ®Ôºâ -->
          <% if (typeof pagination !== 'undefined' && pagination && pagination.totalPages > 1) { %>
            <div class="pagination-container" style="margin-top: 20px;">
              <div class="pagination">
                <% if (pagination.hasPrev) { %>
                  <a href="?<%= getQueryString({page: pagination.page - 1}) %>" class="page-link">‚Üê Ââç„Å∏</a>
                <% } %>

                <%
                  const maxVisible2 = 5;
                  let startPage2 = Math.max(1, pagination.page - Math.floor(maxVisible2 / 2));
                  let endPage2 = Math.min(pagination.totalPages, startPage2 + maxVisible2 - 1);
                  if (endPage2 - startPage2 < maxVisible2 - 1) {
                    startPage2 = Math.max(1, endPage2 - maxVisible2 + 1);
                  }
                %>

                <% if (startPage2 > 1) { %>
                  <a href="?<%= getQueryString({page: 1}) %>" class="page-link">1</a>
                  <% if (startPage2 > 2) { %>
                    <span class="page-dots">...</span>
                  <% } %>
                <% } %>

                <% for (let i = startPage2; i <= endPage2; i++) { %>
                  <% if (i === pagination.page) { %>
                    <span class="page-current"><%= i %></span>
                  <% } else { %>
                    <a href="?<%= getQueryString({page: i}) %>" class="page-link"><%= i %></a>
                  <% } %>
                <% } %>

                <% if (endPage2 < pagination.totalPages) { %>
                  <% if (endPage2 < pagination.totalPages - 1) { %>
                    <span class="page-dots">...</span>
                  <% } %>
                  <a href="?<%= getQueryString({page: pagination.totalPages}) %>" class="page-link"><%= pagination.totalPages %></a>
                <% } %>

                <% if (pagination.hasNext) { %>
                  <a href="?<%= getQueryString({page: pagination.page + 1}) %>" class="page-link">Ê¨°„Å∏ ‚Üí</a>
                <% } %>
              </div>
            </div>
          <% } %>
        <% } %>
      </div>
    </main>

    <footer>
      <p>&copy; 2025 Ê´ªÂùÇ46 „Éñ„É≠„Ç∞„Ç¢„Éº„Ç´„Ç§„Éñ</p>
    </footer>
  </div>

  <script>
    // Ë°®Á§∫‰ª∂Êï∞Â§âÊõ¥
    function changePerPage(value) {
      const params = new URLSearchParams(window.location.search);
      params.set('per_page', value);
      params.delete('page'); // „Éö„Éº„Ç∏Áï™Âè∑„Çí„É™„Çª„ÉÉ„Éà
      window.location.href = '?' + params.toString();
    }
  </script>
</body>
</html>
