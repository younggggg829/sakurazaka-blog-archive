# 🌸 Sakurazaka46・Keyakizaka46 ブログアーカイブツール

櫻坂 46 と欅坂 46 のブログ記事をスクレイピング・保存・検索できるツールです。画像の自動ダウンロード機能付き。

## ✨ 主要機能

- 🌸 **双方ブログサポート**: 櫻坂 46 と欅坂 46 の両方のブログをサポート
- 🌐 **メンバー一覧取得**: 公式サイトから自動取得
- 📝 **ブログスクレイピング**: 指定メンバーのブログ記事を取得（サイト別ラベル付き）
- 📷 **画像ローカル保存**: ブログ画像をダウンロード
- 💾 **データベース保存**: SQLite で永続化（サイト識別付き）
- 🔍 **全文検索**: タイトル・本文から検索
- 🌐 **Web ビューアー**: ブラウザで閲覧可能

## 🏗️ システム構成

### 💾 データベース構造（SQLite）

**データベースファイル**: `sakurazaka_blog.db`

#### 📋 テーブル構成

1. **members**（櫻坂 46 現役メンバー情報）

   ```sql
   - id: メンバーID (例: 47)
   - name: メンバー名 (例: 森田ひかる)
   - blog_url: 櫻坂46 公式ブログURL
   ```

2. **blog_posts**（ブログ記事）

   ```sql
   - id: 記事ID（自動採番）
   - member_id: メンバーID (外部キー)
   - member_name: メンバー名
   - url: 元ブログURL (一意)
   - title: 記事タイトル
   - date: 投稿日
   - content: 記事本文
   - site: サイト識別子 ('sakurazaka46' または 'keyakizaka46')
   - created_at: 保存日時
   ```

3. **blog_images**（記事画像）
   ```sql
   - id: 画像ID（自動採番）
   - post_id: 記事ID (外部キー)
   - image_url: 元画像URL
   - local_path: ローカル保存パス
   ```

### 画像保存構造

```
images/
├── 森田ひかる_sakurazaka46/
├── 森田ひかる_keyakizaka46/
├── 小田倉麗奈_sakurazaka46/
├── 村山美羽_sakurazaka46/
└── ...
```

- フォルダ名: `{メンバー名}_{サイト識別子}`
- ファイル名: `post_{投稿ID}_{ハッシュ}.jpg`
- サイト識別子: `sakurazaka46` または `keyakizaka46`

## 📦 インストール方法

- DEPLOYMENT.md を参照してください

## 🚀 使用方法

### 基本的な使い方

```bash
# CLIモードで起動
npm start

# または直接実行
node index.js

# Webサーバーを直接起動
node webServer.js
```

### テストの実行

```bash
# すべてのテストを実行
npm test

# テストをウォッチモードで実行（開発時）
npm run test:watch

# カバレッジレポートを生成
npm run test:coverage
```

**メニュー一覧：**

1. **🌐 Open member blog in browser**

   - メンバー選択画面が表示
   - 選択したメンバーのブログが Chrome で開く
   - Enter キーでブラウザを閉じる

2. **💾 Scrape and save sakurazaka46 blog posts**（櫻坂 46）

   ```
   a) メンバー選択 → 33名から選択
   b) 記事数入力 → 1-100 または "all"
   c) 画像DL選択 → y/n
   d) 自動実行開始 → レート制限付きで安全にスクレイピング
   ```

3. **🌳 Scrape Keyakizaka46 blog posts**（欅坂 46）

   ```
   a) 欅坂46メンバー選択 → 現櫻坂46メンバーの欅坂時代から選択（27名）
   b) 記事数入力 → 1-100 または "all"
   c) 画像DL選択 → y/n
   d) 自動実行開始 → 欅坂46サイトから記事をスクレイピング

   対応メンバー例:
   - 菅井友香、渡邉理佐、守屋茜、森田ひかるなど
   - site識別子は "keyakizaka46" として保存
   ```

4. **🔍 Search saved blog posts**

   - キーワード入力でタイトル・本文を検索
   - 部分一致で検索結果を表示

5. **🌐 Web ページビューアーを起動**

   - バックグラウンドで Web サーバーを起動
   - ブラウザで http://localhost:3000 にアクセス
   - サーバーは起動し続け、いつでもメインメニューに戻れる

6. **❌ Exit**
   - プログラムを終了

### 🌐 Web ビューアー（推奨・簡単操作）

```bash
npm start
```

ブラウザで `http://localhost:3000` にアクセス

**操作方法：**

1. **📊 統合表示**: 櫻坂 46・欅坂 46 の記事を統合表示（サイトラベル付き）
2. **🔍 検索画面（2 段階）**:

   - **簡易検索**: キーワード + メンバー選択
   - **詳細検索**: ⚙️ ボタンで高度な条件設定
     - 表示設定（件数・並び順）
     - 複数メンバー選択（チェックボックス）
     - 投稿期間指定（年月範囲）

3. **👥 メンバー管理**:
   - 「メンバー一覧」で全 33 名表示
   - カードクリックで該当メンバーの記事一覧
   - 記事数の統計表示

### 🤖 自動レート制限機能

スクレイピング時の自動制御：

- ⏱️ **最小 2 秒間隔**: リクエスト間に 2-4 秒のランダム待機
- 📊 **1 分間 15 リクエスト制限**: 適度な処理速度を維持
- ⏸️ **10 件ごとに 5 秒休憩**: 連続処理後に短い休憩
- 📈 **リアルタイム統計**: 進行状況と平均処理時間を表示

## 🎯 主な機能詳細

### 1. スクレイピング機能

- **記事数指定**: 1-100 記事または全件
- **画像ダウンロード**: オプション選択可能
- **画像抽出**: ブログ記事内の画像のみを正確に抽出（サイト共通要素を除外）
- **重複回避**: メンバー・投稿別キャッシュで効率化
- **並列処理**: 3 枚同時 DL、リトライ機能

### 2. 画像最適化システム

- ✅ MD5 ハッシュによる重複防止
- ✅ メンバー別フォルダ整理
- ✅ 自動リサイズ・フォーマット統一
- ✅ プログレス表示

### 3. Web ビューアー

- 🔍 **検索画面**: キーワード＋メンバー絞り込み
- 📊 **テーブルビュー**: クリックで本文展開
- 📇 **カードビュー**: 視覚的な記事一覧
- 📱 **レスポンシブ**: モバイル対応

### 4. 高度な検索

- **全文検索**: タイトル・本文からキーワード検索
- **メンバー別フィルタリング**: 単一またはチェックボックスで複数選択
- **期間指定**: 年月範囲での絞り込み
- **表示設定**: 件数（10-100 件）、並び順（新しい順/古い順）

### 5. 投稿削除機能 🗑️

- **一括削除**: チェックボックスで複数選択し、まとめて削除
  - 「全選択」「全解除」ボタンで効率的な選択
  - 選択件数をリアルタイムで表示
  - 一括削除時も確認ダイアログで誤削除防止
- **確認ダイアログ**: 誤削除防止
- **データベース削除**: 記事・画像レコード・ローカル画像ファイルを完全削除

## 🛠️ 技術スタック

### バックエンド

- **Node.js** 20+: サーバーサイド実行環境
- **Playwright** 1.56.1: Web スクレイピング
- **SQLite3** 5.1.7: データベース
- **Express.js** 5.1.0: Web サーバー
- **EJS** 3.1.10: テンプレートエンジン

### 開発ツール

- **Jest** 29.7.0: テストフレームワーク
- **Inquirer** 12.10.0: CLI インターフェース
- **Chalk** 4.1.2: ターミナル装飾

### その他

- **画像処理**: ネイティブ Node.js（https/http）
- **Docker**: コンテナ化対応

## 📊 統計情報・実行例

### データベース情報確認

```bash
# 保存済み記事数を確認
node -e "const db = require('./database'); const d = new db(); d.getAllBlogPosts().then(posts => console.log(\`記事数: \${posts.length}\`));"

# 画像統計を確認
node -e "const {getImageStatsOptimized} = require('./imageDownloader'); console.log(getImageStatsOptimized());"
```

### スクレイピング実行例

```bash
$ node index.js
=== Sakurazaka46 Blog Tool ===

? What would you like to do? 💾 Scrape and save sakurazaka46 blog posts

? Select a member: 森田ひかる (ID: 47)
? スクレイピングする記事数を入力（"all"で全件）: 3
? 画像をダウンロードしますか？ Yes

森田ひかるさんのブログ記事を3件スクレイピング中...
  🚀 スクレイピング開始 - 適切な間隔で処理します
  📊 3件の投稿を処理します
  📄 [1/3] タイトル1
  📄 [2/3] タイトル2
  📄 [3/3] タイトル3
✨ スクレイピング完了: 3件 (1103.7秒)
📊 平均処理時間: 367.9秒/件
✓ Scraped 3 posts
Saving to database...
✓ データベースに保存しました

📷 画像をダウンロード中...
  📦 キャッシュ使用: post_12345_a1b2c3d4.jpg
  📥 ダウンロード開始: image001.jpg
  ✅ 保存完了: post_12346_b2c3d4e5.jpg (245.3KB)
  進捗: 1/3 完了
  ・・・
✨ ダウンロード完了: 3/3 成功
```

## 🗂️ ファイル構成

### 📁 主要ファイル

- `index.js` - メインの CLI インターフェース
- `webServer.js` - Express.js サーバー
- `fetchMembers.js` - メンバーリスト取得
- `blogScraper.js` - 櫻坂 46 ブログスクレイピング
- `keyakiBlogScraper.js` - 欅坂 46 ブログスクレイピング
- `imageDownloader.js` - 画像ダウンロード・最適化
- `database.js` - SQLite データベース操作（async/await 対応）
- `config.js` - アプリケーション設定
- `storageAdapter.js` - ストレージ抽象化レイヤー

### 📂 ユーティリティ（utils/）

- `dateUtils.js` - 日付処理の共通関数
- `constants.js` - 定数定義（レート制限、セレクター等）
- `formatting.js` - テキスト整形・HTML クリーニング
- `scraperUtils.js` - スクレイピング共通処理
- `errorHandler.js` - 統一されたエラーハンドリング
- `*.test.js` - Jest テストファイル

### 📂 その他

- `views/` - EJS テンプレート
- `public/` - 静的ファイル（CSS 等）
- `.gitignore` - キャッシュファイル除外設定

### 📄 ドキュメント

- `README.md` - このファイル
- `PROJECT_STRUCTURE.md` - プロジェクト構造詳細
- `DEPLOYMENT.md` - デプロイ手順
- `DEPLOYMENT_EC2_S3.md` - AWS デプロイ手順

## 👥 対応メンバー

### 櫻坂 46（33 名）

井上梨名、武元唯衣、田村保乃、藤吉夏鈴、松田里奈、森田ひかる、山﨑天、
遠藤光莉、大園玲、大沼晶保、幸阪茉里乃、増本綺良、守屋麗奈、石森璃花、
遠藤理子、小田倉麗奈、小島凪紗、谷口愛季、中嶋優月、的野美青、向井純葉、
村井優、村山美羽、山下瞳月、浅井恋乃未、稲熊ひな、勝又春、佐藤愛桜、
中川智尋、松本和子、目黒陽色、山川宇衣、山田桃実

### 欅坂 46（27 名 - 元欅坂 46 メンバーの欅坂時代ブログ）

上村莉菜、尾関梨香、小池美波、小林由依、齋藤冬優花、佐藤詩織、菅井友香、
土生瑞穂、原田葵、守屋茜、渡辺梨加、渡邉理佐、井上梨名、関有美子、武元唯衣、
田村保乃、藤吉夏鈴、松田里奈、松平璃子、森田ひかる、山﨑天、遠藤光莉、大園玲、
大沼晶保、幸阪茉里乃、増本綺良、守屋麗奈

**注**: 欅坂 46 メンバーは現在の櫻坂 46 メンバーの中から、欅坂 46 時代に活動していたメンバーのみが対象です。

## 📌 バージョン情報

**Current Version: v1.1.0**

### 最新アップデート（2025-10-30）

### 主な機能

- **🌸 櫻坂 46 & 欅坂 46 対応**: 両グループのブログをスクレイピング・アーカイブ
- **💾 統合データベース**: SQLite で両サイトの記事を一元管理（site 識別子付き）
- **🔍 全文検索**: キーワード・メンバー・期間で柔軟に検索
- **📷 画像管理**: 自動ダウンロード・最適化・重複防止
- **🌐 Web ビューアー**: ブラウザで快適に閲覧（テーブル/カードビュー切替）
- **⚡ ページング**: 20/50/100 件表示選択
- **🗑️ 一括削除**: チェックボックスで複数記事を選択削除
- **🧪 テストカバレッジ**: 50%以上のコードカバレッジ

## ⚠️ 注意事項

- スクレイピングは適切な間隔で実行してください
- 公式サイトの利用規約を遵守してください
- 画像ダウンロードはディスク容量にご注意ください
- 初回実行時に自動でメンバーリストを取得します

## 🔄 アプリの稼働管理

### 📊 稼働状況の確認

Web サーバーが起動しているか確認する方法：

```bash
# ポート3000を使用しているプロセスを確認
lsof -i :3000

# または、プロセス一覧から確認
ps aux | grep "node webServer.js" | grep -v grep
```

**出力例：**

```
COMMAND   PID    USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
node    24540 user001   15u  IPv4  ...      0t0  TCP *:hbci (LISTEN)
```

- **PID**: プロセス ID（例: 24540）
- **LISTEN**: サーバーが起動中であることを示す

### ⏸️ アプリの停止

```bash
# 方法1: ポート3000を使用しているプロセスを停止
lsof -ti:3000 | xargs kill -9

# 方法2: プロセスIDを指定して停止
kill -9 24540  # 24540は稼働状況確認で取得したPID
```

### 🔄 アプリの再起動

```bash
# 古いプロセスを停止してから再起動
lsof -ti:3000 | xargs kill -9 2>/dev/null || true
node webServer.js
```

### 🌙 バックグラウンドで起動

ターミナルを閉じても動作し続ける方法：

```bash
# nohupを使用してバックグラウンド起動
lsof -ti:3000 | xargs kill -9 2>/dev/null || true
nohup node webServer.js > webserver.log 2>&1 &

# ログファイルで動作確認
tail -f webserver.log
```

**説明：**

- `nohup`: ターミナル終了後も実行継続
- `> webserver.log`: 出力をファイルに保存（オプション）
- `2>&1`: エラー出力も同じファイルに
- `&`: バックグラウンド実行

**注意**: ログファイルを作成したい場合は、上記のように`> webserver.log`でリダイレクトしてください。デフォルトではコンソールに出力されます。

### 🔍 トラブルシューティング（稼働管理）

#### サーバーが起動しない場合

```bash
# 1. ポートが使用中か確認
lsof -i :3000

# 2. ポートを使用中のプロセスを強制終了
lsof -ti:3000 | xargs kill -9

# 3. 再起動
node webServer.js
```

#### 複数のプロセスが起動している場合

```bash
# 全てのwebServer.jsプロセスを確認
ps aux | grep "node webServer.js" | grep -v grep

# 全て停止
pkill -f "node webServer.js"

# または個別に停止
kill -9 [PID1] [PID2] [PID3]
```

## 🛠️ トラブルシューティング

### 🔧 よくある問題と解決法

#### 🧪 テスト関連

- **Jest がインストールされていない**:
  ```bash
  npm install --save-dev jest@^29.7.0
  ```
- **テストが失敗する**:

  ```bash
  # Node.jsバージョン確認（推奨: v20以上）
  node -v

  # 依存関係の再インストール
  npm ci

  # キャッシュのクリア
  npm cache clean --force
  ```

#### 📡 接続・取得エラー

- **メンバーリスト取得エラー**: インターネット接続を確認
- **ブラウザが開かない**: `npx playwright install chromium`を再実行
- **画像ダウンロード失敗**: `images/`フォルダの権限を確認

#### 💾 データベース関連エラー

**🚨 「データベースエラー」が表示された場合：**

1. **安全な方法（推奨）**:

   ```bash
   # バックアップを作成
   cp sakurazaka_blog.db sakurazaka_blog_backup.db

   # 問題のあるDBを削除
   rm sakurazaka_blog.db

   # プログラム再起動（自動でDB再作成）
   npm start
   ```

2. **ファイルシステム を使用**:
   - `~/sakurazaka-blog-archive/`フォルダを開く
   - `sakurazaka_blog.db`を右クリック → ゴミ箱に入れる

**❓ データベースリセットの影響:**

- ✅ **保持されるもの**: 画像ファイル、プログラム機能
- ❌ **失われるもの**: 記事データ（再スクレイピングが必要）
- 📦 **バックアップ**: 削除前にバックアップファイル作成

#### 🗑️ 削除機能について

**選択した投稿を削除ボタンをクリックした場合：**

- ✅ データベースから記事情報を完全削除
- ✅ 画像のデータベースレコードも削除
- ✅ ローカル画像ファイル（`images/`フォルダ内）も削除

#### 🔍 データベース内容の確認

**SQLite でデータベースの中身を確認：**

```bash
# 記事数確認
sqlite3 sakurazaka_blog.db "SELECT COUNT(*) FROM blog_posts;"

# メンバー一覧
sqlite3 sakurazaka_blog.db "SELECT * FROM members;"

# 特定メンバーの記事数
sqlite3 sakurazaka_blog.db "SELECT member_name, COUNT(*) FROM blog_posts GROUP BY member_id;"
```

---

## 🔄 更新履歴

### v1.1.0 (2025-10-30)

---

## 📖 関連ドキュメント

- **[PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md)** - プロジェクト構造詳細
- **[DEPLOYMENT.md](DEPLOYMENT.md)** - デプロイ手順
- **[DEPLOYMENT_EC2_S3.md](DEPLOYMENT_EC2_S3.md)** - AWS デプロイ手順

---

**作成者**: young
**ライセンス**: ISC
**バージョン**: v1.1.0
**最終更新**: 2025-10-30
