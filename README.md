# Sakurazaka46・Keyakizaka46 ブログアーカイブツール

櫻坂 46 と欅坂 46 のブログ記事をスクレイピング・保存・検索できるツールです。画像の自動ダウンロード機能付き。

## ✨ 主要機能

- 📝 **双方ブログサポート**: 櫻坂 46 と欅坂 46 の両方のブログをサポート
- 👼🏻 **メンバー一覧取得**: 公式サイトから自動取得
- 🪏 **ブログスクレイピング**: 指定メンバーのブログ記事を取得（サイト別ラベル付き）
- 📷 **画像ローカル保存**: ブログ画像をダウンロード
- 💾 **データベース保存**: SQLite で永続化（サイト識別付き）
- 🔍 **全文検索**: タイトル・本文から検索
- 🌐 **Web ビューアー**: ブラウザで閲覧可能

## 📦 インストール方法

./docs/DEPLOYMENT.md を参照してください

## 🚀 使用方法

### 基本的な使い方

```bash
# CLIモードで起動
npm start

# または直接実行
node index.js

# Webサーバーを直接起動
node webServer.js
```

### テストの実行

```bash
# すべてのテストを実行
npm test

# テストをウォッチモードで実行（開発時）
npm run test:watch

# カバレッジレポートを生成
npm run test:coverage
```

**メニュー一覧：**

1. **🌐 Open member blog in browser**

   - メンバー選択画面が表示
   - 選択したメンバーのブログが Chrome で開く
   - Enter キーでブラウザを閉じる

2. **💾 Scrape and save sakurazaka46 blog posts**（櫻坂 46）

   ```
   a) メンバー選択 → 33名から選択
   b) 記事数入力 → 1-100 または "all"
   c) 画像DL選択 → y/n
   d) 自動実行開始 → レート制限付きで安全にスクレイピング
   ```

3. **🌳 Scrape Keyakizaka46 blog posts**（欅坂 46）

   ```
   a) 欅坂46メンバー選択 → 現櫻坂46メンバーの欅坂時代から選択（27名）
   b) 記事数入力 → 1-100 または "all"
   c) 画像DL選択 → y/n
   d) 自動実行開始 → 欅坂46サイトから記事をスクレイピング

   対応メンバー例:
   - 菅井友香、渡邉理佐、守屋茜、森田ひかるなど
   - site識別子は "keyakizaka46" として保存
   ```

4. **🔍 Search saved blog posts**

   - キーワード入力でタイトル・本文を検索
   - 部分一致で検索結果を表示

5. **🌐 Web ページビューアーを起動**

   - バックグラウンドで Web サーバーを起動
   - ブラウザで http://localhost:3000 にアクセス
   - サーバーは起動し続け、いつでもメインメニューに戻れる

6. **❌ Exit**
   - プログラムを終了

### 🌐 Web ビューアー（推奨・簡単操作）

```bash
npm start

メニューから「🌐 Web ページビューアーを起動」　を選択
```

ブラウザで `http://localhost:3000` にアクセス

**操作方法：**

1. **📊 統合表示**: 櫻坂 46・欅坂 46 の記事を統合表示（サイトラベル付き）
2. **🔍 検索画面（2 段階）**:

   - **簡易検索**: キーワード + メンバー選択
   - **詳細検索**: ⚙️ ボタンで高度な条件設定
     - 表示設定（件数・並び順）
     - 複数メンバー選択（チェックボックス）
     - 投稿期間指定（年月範囲）

3. **👥 メンバー管理**:
   - 「メンバー一覧」で全 33 名表示
   - カードクリックで該当メンバーの記事一覧
   - 記事数の統計表示

### 🤖 自動レート制限機能

スクレイピング時の自動制御：

- ⏱️ **最小 2 秒間隔**: リクエスト間に 2-4 秒のランダム待機
- 📊 **1 分間 15 リクエスト制限**: 適度な処理速度を維持
- ⏸️ **10 件ごとに 5 秒休憩**: 連続処理後に短い休憩
- 📈 **リアルタイム統計**: 進行状況と平均処理時間を表示

## 🎯 主な機能詳細

### 1. スクレイピング機能

- **記事数指定**: 1-100 記事または全件
- **画像ダウンロード**: オプション選択可能
- **画像抽出**: ブログ記事内の画像のみを正確に抽出（サイト共通要素を除外）
- **重複回避**: メンバー・投稿別キャッシュで効率化
- **並列処理**: 3 枚同時 DL、リトライ機能

### 2. 画像最適化システム

- ✅ MD5 ハッシュによる重複防止
- ✅ メンバー別フォルダ整理
- ✅ 自動リサイズ・フォーマット統一
- ✅ プログレス表示

### 3. Web ビューアー

- 🔍 **検索画面**: キーワード＋メンバー絞り込み
- 📊 **テーブルビュー**: クリックで本文展開
- 📇 **カードビュー**: 視覚的な記事一覧
- 📱 **レスポンシブ**: モバイル対応

### 4. 高度な検索

- **全文検索**: タイトル・本文からキーワード検索
- **メンバー別フィルタリング**: 単一またはチェックボックスで複数選択
- **期間指定**: 年月範囲での絞り込み
- **表示設定**: 件数（10-100 件）、並び順（新しい順/古い順）

### 5. 投稿削除機能 🗑️

- **一括削除**: チェックボックスで複数選択し、まとめて削除
  - 「全選択」「全解除」ボタンで効率的な選択
  - 選択件数をリアルタイムで表示
  - 一括削除時も確認ダイアログで誤削除防止
- **確認ダイアログ**: 誤削除防止
- **データベース削除**: 記事・画像レコード・ローカル画像ファイルを完全削除

## 🛠️ 技術スタック

### バックエンド

- **Node.js** 20+: サーバーサイド実行環境
- **Playwright** 1.56.1: Web スクレイピング
- **SQLite3** 5.1.7: データベース
- **Express.js** 5.1.0: Web サーバー
- **EJS** 3.1.10: テンプレートエンジン

### 開発ツール

- **Jest** 29.7.0: テストフレームワーク
- **Inquirer** 12.10.0: CLI インターフェース
- **Chalk** 4.1.2: ターミナル装飾

### その他

- **画像処理**: ネイティブ Node.js（https/http）
- **Docker**: コンテナ化対応

## 📊 統計情報・実行例

### データベース情報確認

```bash
# 保存済み記事数を確認
node -e "const db = require('./database'); const d = new db(); d.getAllBlogPosts().then(posts => console.log(\`記事数: \${posts.length}\`));"

# 画像統計を確認
node -e "const {getImageStatsOptimized} = require('./imageDownloader'); console.log(getImageStatsOptimized());"
```

### スクレイピング実行例

```bash
$ node index.js
=== Sakurazaka46 Blog Tool ===

? What would you like to do? 💾 Scrape and save sakurazaka46 blog posts

? Select a member: 森田ひかる (ID: 47)
? スクレイピングする記事数を入力（"all"で全件）: 3
? 画像をダウンロードしますか？ Yes

森田ひかるさんのブログ記事を3件スクレイピング中...
  🚀 スクレイピング開始 - 適切な間隔で処理します
  📊 3件の投稿を処理します
  📄 [1/3] タイトル1
  📄 [2/3] タイトル2
  📄 [3/3] タイトル3
✨ スクレイピング完了: 3件 (1103.7秒)
📊 平均処理時間: 367.9秒/件
✓ Scraped 3 posts
Saving to database...
✓ データベースに保存しました

📷 画像をダウンロード中...
  📦 キャッシュ使用: post_12345_a1b2c3d4.jpg
  📥 ダウンロード開始: image001.jpg
  ✅ 保存完了: post_12346_b2c3d4e5.jpg (245.3KB)
  進捗: 1/3 完了
  ・・・
✨ ダウンロード完了: 3/3 成功
```

## 🗂️ ファイル構成

./docs/PROJECT_STRUCTURE.md を参照してください

## 👥 対応メンバー

### 櫻坂 46（33 名）

井上梨名、武元唯衣、田村保乃、藤吉夏鈴、松田里奈、森田ひかる、山﨑天、
遠藤光莉、大園玲、大沼晶保、幸阪茉里乃、増本綺良、守屋麗奈、石森璃花、
遠藤理子、小田倉麗奈、小島凪紗、谷口愛季、中嶋優月、的野美青、向井純葉、
村井優、村山美羽、山下瞳月、浅井恋乃未、稲熊ひな、勝又春、佐藤愛桜、
中川智尋、松本和子、目黒陽色、山川宇衣、山田桃実

### 欅坂 46（27 名 - 元欅坂 46 メンバーの欅坂時代ブログ）

上村莉菜、尾関梨香、小池美波、小林由依、齋藤冬優花、佐藤詩織、菅井友香、
土生瑞穂、原田葵、守屋茜、渡辺梨加、渡邉理佐、井上梨名、関有美子、武元唯衣、
田村保乃、藤吉夏鈴、松田里奈、松平璃子、森田ひかる、山﨑天、遠藤光莉、大園玲、
大沼晶保、幸阪茉里乃、増本綺良、守屋麗奈

**注**: 欅坂 46 メンバーは現在の櫻坂 46 メンバーの中から、欅坂 46 時代に活動していたメンバーのみが対象です。

## ⚠️ 注意事項

- スクレイピングは適切な間隔で実行してください
- 公式サイトの利用規約を遵守してください
- 画像ダウンロードはディスク容量にご注意ください
- 初回実行時に自動でメンバーリストを取得します

## 🔄 アプリの稼働管理

### 📊 稼働状況の確認

Web サーバーが起動しているか確認する方法：

```bash
# ポート3000を使用しているプロセスを確認
lsof -i :3000

# または、プロセス一覧から確認
ps aux | grep "node webServer.js" | grep -v grep
```

**出力例：**

```
COMMAND   PID    USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
node    24540 user001   15u  IPv4  ...      0t0  TCP *:hbci (LISTEN)
```

- **PID**: プロセス ID（例: 24540）
- **LISTEN**: サーバーが起動中であることを示す

### ⏸️ アプリの停止

```bash
# 方法1: ポート3000を使用しているプロセスを停止
lsof -ti:3000 | xargs kill -9

# 方法2: プロセスIDを指定して停止
kill -9 24540  # 24540は稼働状況確認で取得したPID
```

### 🔄 アプリの再起動

```bash
# 古いプロセスを停止してから再起動
lsof -ti:3000 | xargs kill -9 2>/dev/null || true
node webServer.js
```

## 📌 バージョン情報

### **Current Version: v1.1.0**

## 🔄 更新履歴

### v1.1.0 リリース（2025-10-30）

---

**作成者**: young
**ライセンス**: ISC
**バージョン**: v1.1.0
**最終更新**: 2025-10-30
